// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY & AUTHENTICATION
// ============================================

model Tenant {
  id            String   @id @default(cuid())
  companyName   String
  gstin         String   @unique
  pan           String
  state         String
  address       String
  email         String
  phone         String
  financialYear String   // e.g., "2024-25"
  turnover      String   // e.g., "Below 40 Lakhs", "40L-1.5Cr", "Above 1.5Cr"
  gstRegType    String   // Regular, Composition, Unregistered
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  users         User[]
  ledgers       Ledger[]
  groups        Group[]
  vouchers      Voucher[]
  invoices      Invoice[]
  purchaseBills PurchaseBill[]
  hsnCodes      HSNCode[]
  gstReturns    GSTReturn[]
  items         Item[]
  employees     Employee[]
  
  @@map("tenants")
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  password      String
  role          String   @default("user") // admin, accountant, user
  permissions   Json?    // Module-based permissions
  designation   String?
  language      String   @default("en")    // Preferred language code
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("users")
}

model Employee {
  id            String   @id @default(cuid())
  name          String
  designation   String
  department    String?
  email         String?
  phone         String?
  address       String?
  dateOfJoining DateTime
  salary        Float?
  status        String   @default("Active") // Active, Inactive, OnLeave
  bankDetails   Json?    // { bankName, accountNo, ifsc }
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("employees")
}

// ============================================
// EMAIL VERIFICATION
// ============================================

model EmailVerification {
  id            String   @id @default(cuid())
  email         String   // Email to verify
  code          String   // 6-digit OTP code
  name          String?  // User's name from registration
  expiresAt     DateTime // Expiration time (10 minutes)
  verified      Boolean  @default(false)
  attempts      Int      @default(0) // Track verification attempts
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([email])
  @@index([email, verified])
  @@map("email_verifications")
}

// ============================================
// TRANSLATION CACHE
// ============================================

model Translation {
  id            String   @id @default(cuid())
  sourceText    String   // Original English text
  targetLang    String   // Target language code (hi, ta, te, etc.)
  translatedText String  // Translated text
  
  createdAt     DateTime @default(now())
  
  @@unique([sourceText, targetLang])
  @@index([sourceText, targetLang])
  @@map("translations")
}


// ============================================
// INVENTORY / ITEMS
// ============================================

model Item {
  id            String   @id @default(cuid())
  name          String
  hsnCode       String?  // HSN/SAC code
  unit          String   @default("NOS")
  gstRate       Float    @default(18)
  sellingPrice  Float    @default(0)
  purchasePrice Float    @default(0)
  openingStock  Float    @default(0)
  currentStock  Float    @default(0)
  description   String?
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([tenantId, name])
  @@map("items")
}

// ============================================
// ACCOUNTING CORE - DOUBLE ENTRY
// ============================================

model Group {
  id            String   @id @default(cuid())
  name          String
  parentId      String?
  parent        Group?   @relation("GroupHierarchy", fields: [parentId], references: [id])
  children      Group[]  @relation("GroupHierarchy")
  nature        String   // Asset, Liability, Income, Expense
  affectsGross  Boolean  @default(false)
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  ledgers       Ledger[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([tenantId, name])
  @@map("groups")
}

model Ledger {
  id            String   @id @default(cuid())
  name          String
  alias         String?
  
  groupId       String
  group         Group    @relation(fields: [groupId], references: [id])
  
  openingBalance Decimal @default(0)
  currentBalance Decimal @default(0)
  
  // GST specific fields
  gstin         String?
  pan           String?
  address       String?
  state         String?
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Relations
  voucherEntriesDebit  VoucherEntry[] @relation("DebitEntries")
  voucherEntriesCredit VoucherEntry[] @relation("CreditEntries")
  invoicesAsCustomer   Invoice[]      @relation("CustomerInvoices")
  purchaseBillsAsVendor PurchaseBill[] @relation("VendorBills")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([tenantId, name])
  @@map("ledgers")
}

model Voucher {
  id            String   @id @default(cuid())
  voucherNumber String
  voucherType   String   // Journal, Payment, Receipt, Contra, Sales, Purchase
  date          DateTime
  narration     String?
  
  totalAmount   Decimal
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  entries       VoucherEntry[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([tenantId, voucherNumber])
  @@map("vouchers")
}

model VoucherEntry {
  id            String   @id @default(cuid())
  
  voucherId     String
  voucher       Voucher  @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  
  debitLedgerId  String?
  debitLedger    Ledger?  @relation("DebitEntries", fields: [debitLedgerId], references: [id])
  
  creditLedgerId String?
  creditLedger   Ledger?  @relation("CreditEntries", fields: [creditLedgerId], references: [id])
  
  amount        Decimal
  
  createdAt     DateTime @default(now())
  
  @@map("voucher_entries")
}

// ============================================
// GST INVOICING
// ============================================

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String
  invoiceDate   DateTime
  
  customerId    String
  customer      Ledger   @relation("CustomerInvoices", fields: [customerId], references: [id])
  
  placeOfSupply String   // State code
  supplyType    String   // Intrastate, Interstate
  
  subtotal      Decimal
  cgst          Decimal  @default(0)
  sgst          Decimal  @default(0)
  igst          Decimal  @default(0)
  totalAmount   Decimal
  
  roundOff      Decimal  @default(0)
  
  notes         String?
  terms         String?
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  items         InvoiceItem[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([tenantId, invoiceNumber])
  @@map("invoices")
}

model InvoiceItem {
  id            String   @id @default(cuid())
  
  invoiceId     String
  invoice       Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  description   String
  hsnCode       String?
  quantity      Decimal
  unit          String   @default("NOS")
  rate          Decimal
  amount        Decimal
  
  gstRate       Decimal
  cgst          Decimal  @default(0)
  sgst          Decimal  @default(0)
  igst          Decimal  @default(0)
  
  @@map("invoice_items")
}

model PurchaseBill {
  id            String   @id @default(cuid())
  billNumber    String
  billDate      DateTime
  
  vendorId      String
  vendor        Ledger   @relation("VendorBills", fields: [vendorId], references: [id])
  
  vendorGSTIN   String?
  placeOfSupply String
  supplyType    String
  
  subtotal      Decimal
  cgst          Decimal  @default(0)
  sgst          Decimal  @default(0)
  igst          Decimal  @default(0)
  totalAmount   Decimal
  
  itcEligible   Boolean  @default(true)
  itcClaimed    Decimal  @default(0)
  
  // OCR extracted data
  ocrData       Json?
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  items         PurchaseBillItem[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([tenantId, billNumber, vendorId])
  @@map("purchase_bills")
}

model PurchaseBillItem {
  id            String   @id @default(cuid())
  
  billId        String
  bill          PurchaseBill @relation(fields: [billId], references: [id], onDelete: Cascade)
  
  description   String
  hsnCode       String?
  quantity      Decimal
  unit          String   @default("NOS")
  rate          Decimal
  amount        Decimal
  
  gstRate       Decimal
  cgst          Decimal  @default(0)
  sgst          Decimal  @default(0)
  igst          Decimal  @default(0)
  
  @@map("purchase_bill_items")
}

// ============================================
// GST MASTER DATA
// ============================================

model HSNCode {
  id              String   @id @default(cuid())
  code            String   // 8-digit code (e.g., "84713000")
  description     String   // Full description
  chapter         String   // Chapter number (2 digits)
  chapterName     String   // Chapter description
  section         String   // Section (Roman numeral I-XXI)
  sectionName     String   // Section description
  heading         String   // 4-digit heading
  subHeading      String?  // 6-digit subheading
  
  // GST Details (India-specific)
  gstRate         Decimal? // GST rate (0, 5, 12, 18, 28)
  cessRate        Decimal? // Additional cess if applicable
  igstRate        Decimal? // IGST rate
  cgstRate        Decimal? // CGST rate
  sgstRate        Decimal? // SGST rate
  
  // Additional metadata
  uom             String?  // Unit of measurement
  exempted        Boolean  @default(false)
  reverseCharge   Boolean  @default(false)
  category        String   @default("Goods") // Goods, Services
  
  // Hierarchy
  parentCode      String?  // For building tree structure
  level           Int      // 2=chapter, 4=heading, 6=subheading, 8=tariff
  
  // Multi-language support
  descriptionHi   String?  // Hindi
  descriptionTa   String?  // Tamil
  descriptionTe   String?  // Telugu
  
  // Tenant customization
  tenantId        String?
  tenant          Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  isGlobal        Boolean  @default(true) // Global vs tenant-specific
  
  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([code, tenantId])
  @@index([code])
  @@index([chapter])
  @@index([heading])
  @@index([isGlobal, tenantId])
  @@map("hsn_codes")
}

// ============================================
// GST RETURNS
// ============================================

model GSTReturn {
  id            String   @id @default(cuid())
  returnType    String   // GSTR1, GSTR3B, GSTR9
  period        String   // e.g., "Jan-2024", "Q1-2024", "FY2023-24"
  month         Int?
  quarter       Int?
  year          Int
  
  status        String   @default("draft") // draft, filed, submitted
  filedDate     DateTime?
  
  // GSTR-1 specific
  b2bInvoices   Int?
  b2cInvoices   Int?
  totalSales    Decimal?
  
  // GSTR-3B specific
  outwardTaxable Decimal?
  inwardTaxable  Decimal?
  itcClaimed     Decimal?
  taxPayable     Decimal?
  
  jsonData      Json?    // Full return data
  
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([tenantId, returnType, period])
  @@map("gst_returns")
}
